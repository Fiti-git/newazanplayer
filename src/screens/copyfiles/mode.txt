import React, { useState } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  TextInput,
  SafeAreaView,
  ImageBackground,
  Alert,
  ActivityIndicator,
} from 'react-native';
import useDisableBack from '../hooks/useDisableBack.js';
import styles from '../styles/modeSelectionStyles.js';
import RNFS from 'react-native-fs';
import {
  checkDeviceStatus,
  registerNewDevice,
  saveDeviceConfig,
  uploadCsvLog,
} from '../services/apiService';
import { sendCsvOverBluetooth } from '../utils/sendCsv.js';

const ModeSelection = ({ route, navigation }) => {
  const {
    mac,
    country,
    city,
    area,
    latitude,
    longitude,
    azanSound,
    prayers,
  } = route.params || {};

  const [mode, setMode] = useState(null);
  const [ssid, setSsid] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  useDisableBack();

  const normalize = (str) => str.toLowerCase().replace(/\s+/g, '_');

  const generateConfigCSV = async (data) => {
    const now = new Date();
    const date = now.toISOString().split('T')[0];
    const time = now.toTimeString().split(' ')[0];

    const csvHeader = 'mac,mode,ssid,password,latitude,longitude,azan,prayers,date,time\n';
    const csvBody = `${data.mac},${data.mode},${data.ssid || ''},${data.password || ''},${data.latitude},${data.longitude},${data.azanSound},"${data.prayers.join(',')}",${date},${time}`;
    const fullCSV = csvHeader + csvBody;
    const path = `${RNFS.DocumentDirectoryPath}/config.csv`;

    await RNFS.writeFile(path, fullCSV, 'utf8');
    console.log('‚úÖ config.csv generated at:', path);
    return path;
  };

  const downloadAzanCsvFromServer = async (filename) => {
    try {
      const url = `https://echostics.com/get_csv.php?file=${filename}`;
      const destPath = `${RNFS.DocumentDirectoryPath}/${filename}`;

      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to fetch ${filename}`);

      const content = await response.text();
      await RNFS.writeFile(destPath, content, 'utf8');

      console.log(`üì• Azan CSV downloaded to: ${destPath}`);
      return destPath;
    } catch (err) {
      console.error('‚ùå Error downloading CSV:', err.message);
      throw err;
    }
  };

  const handleFinish = async () => {
    if (!mode) {
      Alert.alert('Select Mode', 'Please choose a mode to continue.');
      return;
    }

    try {
      setLoading(true);
      setError('');

      console.log('üì¶ Configuration Data');
      console.log({ mac, country, city, area, latitude, longitude, azanSound, prayers });

      const deviceStatus = await checkDeviceStatus(mac);
      if (deviceStatus.status === 'New') {
        await registerNewDevice({ mac_address: mac, country, city, area, mode });
        console.log('‚úÖ Device registered');
      }

      await saveDeviceConfig({
        mac_address: mac,
        mode,
        ssid,
        password,
        latitude,
        longitude,
        azan_sound: azanSound,
        prayers,
      });

      const configPath = await generateConfigCSV({
        mac, mode, ssid, password, latitude, longitude, azanSound, prayers
      });

      const azanFileName = `${normalize(country)}_${normalize(city)}_${normalize(area)}.csv`;
      console.log('üìÅ CSV File to Use:', azanFileName);

      const azanCsvPath = await downloadAzanCsvFromServer(azanFileName);

      await uploadCsvLog({
        mac_address: mac,
        upload_source: mode,
        csv_status: 'success',
        file_path: azanFileName,
        notes: 'Upload via mobile app',
      });

      console.log('üì§ Sending config.csv...');
      await sendCsvOverBluetooth(configPath, 'config');

      console.log('üì§ Sending azan.csv...');
      await sendCsvOverBluetooth(azanCsvPath, 'azan');

      await RNFS.unlink(configPath);
      await RNFS.unlink(azanCsvPath);

      console.log('‚úÖ CSVs sent and cleaned up');
      navigation.navigate('PushScreen');
    } catch (err) {
      console.error('‚ùå Error during submission:', err);
      setError('Something went wrong. Please check your connection and try again.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <SafeAreaView style={styles.safe}>
      <ImageBackground
        source={require('../assets/w-bg.jpg')}
        style={styles.backgroundImage}
      >
        <View style={styles.container}>
          <TouchableOpacity
            style={[styles.card, mode === 'online' && styles.cardSelected]}
            onPress={() => setMode('online')}
            activeOpacity={1}
          >
            <View style={styles.headerRow}>
              <Text style={styles.cardTitle}>Online Mode</Text>
              <View style={[styles.radio, mode === 'online' && styles.radioSelected]} />
            </View>
            <Text style={styles.cardDesc}>
              Prayer times will be based on accurate online data.
            </Text>
            {mode === 'online' && (
              <>
                <TextInput
                  style={styles.input}
                  placeholder="Enter Wi-Fi SSID"
                  value={ssid}
                  onChangeText={setSsid}
                  placeholderTextColor="#999"
                />
                <TextInput
                  style={[styles.input, { flex: 1 }]}
                  placeholder="Enter Wi-Fi Password"
                  value={password}
                  onChangeText={setPassword}
                  placeholderTextColor="#999"
                  secureTextEntry
                />
              </>
            )}
          </TouchableOpacity>

          <TouchableOpacity
            style={[styles.card, mode === 'offline' && styles.cardSelected]}
            onPress={() => setMode('offline')}
            activeOpacity={1}
          >
            <View style={styles.headerRow}>
              <Text style={styles.cardTitle}>Offline Mode</Text>
              <View style={[styles.radio, mode === 'offline' && styles.radioSelected]} />
            </View>
            <Text style={styles.cardDesc}>
              Prayer times will be calculated using the solar method.
            </Text>
          </TouchableOpacity>

          {error ? <Text style={{ color: 'red', marginBottom: 10 }}>{error}</Text> : null}

          {mode && (
            <TouchableOpacity
              style={styles.finishButton}
              onPress={handleFinish}
              disabled={loading}
            >
              <Text style={styles.finishText}>
                {loading ? 'Processing...' : 'Finish'}
              </Text>
              {loading && <ActivityIndicator style={{ marginTop: 10 }} color="#003a7f" />}
            </TouchableOpacity>
          )}
        </View>
      </ImageBackground>
    </SafeAreaView>
  );
};

export default ModeSelection;
